# SSL证书配置和自动续期管理 - 2025年9月4日

## 📋 概述

本文档记录了为 `https://doro.gitagent.io/` 配置Let's Encrypt SSL证书和设置自动续期管理的完整过程。该配置确保网站安全访问，并通过自动化任务保持证书有效性。

### 🎯 目标
- ✅ 为 `doro.gitagent.io` 申请正式的Let's Encrypt SSL证书
- ✅ 配置Nginx使用新的SSL证书
- ✅ 设置自动续期机制，避免证书过期
- ✅ 建立监控和维护机制

---

## 🔧 SSL证书申请和配置

### 1. 环境准备

#### 系统信息
- **服务器**: AWS EC2 (Amazon Linux 2023)
- **Web服务器**: Nginx 1.28.0
- **域名**: doro.gitagent.io
- **IP地址**: 54.89.140.250

#### 安装Certbot
```bash
# 更新系统包
sudo yum update -y

# 安装Certbot和Nginx插件
sudo yum install -y certbot python3-certbot-nginx
```

**安装结果**:
```
Package certbot-2.6.0-4.amzn2023.0.1.noarch is already installed.
Package python3-certbot-nginx-2.6.0-4.amzn2023.0.1.noarch is already installed.
```

### 2. SSL证书申请

#### 使用Certbot申请证书
```bash
sudo certbot --nginx -d doro.gitagent.io --non-interactive --agree-tos --email admin@gitagent.io --redirect
```

**申请结果**:
```
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Certificate not yet due for renewal
Deploying certificate
Successfully deployed certificate for doro.gitagent.io to /etc/nginx/conf.d/doro.gitagent.io.conf
Congratulations! You have successfully enabled HTTPS on https://doro.gitagent.io
```

#### 证书信息
```bash
sudo certbot certificates
```

**证书详情**:
```
Certificate Name: doro.gitagent.io
  Serial Number: 6a27339feab6347df64dc8e071659b94d16
  Key Type: ECDSA
  Domains: doro.gitagent.io
  Expiry Date: 2025-12-03 04:50:51+00:00 (VALID: 89 days)
  Certificate Path: /etc/letsencrypt/live/doro.gitagent.io/fullchain.pem
  Private Key Path: /etc/letsencrypt/live/doro.gitagent.io/privkey.pem
```

### 3. Nginx配置更新

#### 自动更新的配置文件
Certbot自动更新了 `/etc/nginx/conf.d/doro.gitagent.io.conf`：

```nginx
# Doro OrientDirector - doro.gitagent.io 配置
# 与现有的 gitagent.io 配置并存，使用不同端口避免冲突

server {
    if ($host = doro.gitagent.io) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen 80;
    server_name doro.gitagent.io;
    
    # HTTP重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl;
    http2 on;
    server_name doro.gitagent.io;
    
    # 使用Let's Encrypt证书 - 已更新为独立证书
    ssl_certificate /etc/letsencrypt/live/doro.gitagent.io/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/doro.gitagent.io/privkey.pem; # managed by Certbot
    
    # SSL安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # 安全头
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # 日志配置
    access_log /var/log/nginx/doro.gitagent.io.access.log;
    error_log /var/log/nginx/doro.gitagent.io.error.log;
    
    # 客户端最大请求体大小 (用于文件上传)
    client_max_body_size 50M;
    
    # API请求代理到后端 (端口8001，避免与gitagent.io的8000冲突)
    location /api/ {
        proxy_pass http://127.0.0.1:8001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 根路径代理到前端 (端口3001，避免与gitagent.io的3000冲突)
    location / {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }
    
    # WebSocket支持
    location /ws {
        proxy_pass http://127.0.0.1:8001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 健康检查
    location /health {
        access_log off;
        return 200 "doro.gitagent.io healthy\n";
        add_header Content-Type text/plain;
    }
    
    # 静态文件缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://127.0.0.1:3001;
        proxy_set_header Host $host;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

#### 配置验证
```bash
# 测试Nginx配置
sudo nginx -t

# 重新加载Nginx
sudo systemctl reload nginx
```

**验证结果**:
```
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
```

---

## ⚙️ 自动续期配置

### 1. Cron服务安装和配置

#### 安装Cron服务
```bash
# 安装cronie包
sudo yum install -y cronie

# 启用并启动cron服务
sudo systemctl enable crond
sudo systemctl start crond

# 检查服务状态
sudo systemctl status crond
```

**服务状态**:
```
● crond.service - Command Scheduler
     Loaded: loaded (/usr/lib/systemd/system/crond.service)
     Active: active (running) since Thu 2025-09-04 09:45:28 UTC
   Main PID: 2645940 (crond)
      Tasks: 1 (limit: 4656)
     Memory: 984.0K
        CPU: 7ms
```

### 2. 自动续期任务配置

#### 创建Cron任务
```bash
echo "# SSL证书自动续期 - 每天凌晨2点检查并续期 (使用webroot方法)
0 2 * * * /usr/bin/certbot renew --webroot --webroot-path=/var/www/letsencrypt --quiet --post-hook \"/bin/systemctl reload nginx\"

# 每周日凌晨3点清理Let's Encrypt日志
0 3 * * 0 /usr/bin/find /var/log/letsencrypt -name \"*.log\" -mtime +30 -delete 2>/dev/null || true" | sudo crontab -
```

#### 验证Cron任务
```bash
sudo crontab -l
```

**配置结果**:
```
# SSL证书自动续期 - 每天凌晨2点检查并续期 (使用webroot方法)
0 2 * * * /usr/bin/certbot renew --webroot --webroot-path=/var/www/letsencrypt --quiet --post-hook "/bin/systemctl reload nginx"

# 每周日凌晨3点清理Let's Encrypt日志
0 3 * * 0 /usr/bin/find /var/log/letsencrypt -name "*.log" -mtime +30 -delete 2>/dev/null || true
```

### 3. Webroot验证路径配置

#### 创建验证目录
```bash
sudo mkdir -p /var/www/letsencrypt
```

**说明**: 使用webroot方法可以避免在续期时停止Nginx服务，确保网站持续可用。

---

## 📊 SSL证书监控

### 1. 监控脚本创建

#### SSL监控脚本 (`/home/ec2-user/ssl_monitor.sh`)
```bash
#!/bin/bash
# SSL证书监控脚本

echo "=== SSL证书状态监控 ==="
echo "检查时间: $(date)"
echo ""

# 检查证书状态
echo "📋 当前SSL证书列表:"
sudo certbot certificates

echo ""
echo "🔍 证书到期时间检查:"
for domain in doro.gitagent.io gitagent.io; do
    echo "检查域名: $domain"
    expiry=$(openssl s_client -connect $domain:443 -servername $domain < /dev/null 2>/dev/null | openssl x509 -noout -dates | grep notAfter | cut -d= -f2)
    if [ ! -z "$expiry" ]; then
        echo "  到期时间: $expiry"
        # 计算剩余天数
        expiry_epoch=$(date -d "$expiry" +%s 2>/dev/null)
        current_epoch=$(date +%s)
        if [ ! -z "$expiry_epoch" ]; then
            days_left=$(( (expiry_epoch - current_epoch) / 86400 ))
            echo "  剩余天数: $days_left 天"
            if [ $days_left -lt 30 ]; then
                echo "  ⚠️  警告: 证书将在30天内到期!"
            elif [ $days_left -lt 7 ]; then
                echo "  🚨 紧急: 证书将在7天内到期!"
            else
                echo "  ✅ 证书状态正常"
            fi
        fi
    else
        echo "  ❌ 无法获取证书信息"
    fi
    echo ""
done

echo "🔄 Cron任务状态:"
sudo crontab -l | grep certbot

echo ""
echo "📊 Let's Encrypt日志 (最近10行):"
sudo tail -10 /var/log/letsencrypt/letsencrypt.log 2>/dev/null || echo "暂无日志"

echo ""
echo "✅ 监控完成"
```

#### 设置执行权限
```bash
chmod +x /home/ec2-user/ssl_monitor.sh
```

### 2. 监控脚本执行结果

```bash
./ssl_monitor.sh
```

**监控输出**:
```
=== SSL证书状态监控 ===
检查时间: Thu Sep  4 09:53:28 UTC 2025

📋 当前SSL证书列表:
  Certificate Name: doro.gitagent.io
    Serial Number: 6a27339feab6347df64dc8e071659b94d16
    Key Type: ECDSA
    Domains: doro.gitagent.io
    Expiry Date: 2025-12-03 04:50:51+00:00 (VALID: 89 days)
    Certificate Path: /etc/letsencrypt/live/doro.gitagent.io/fullchain.pem
    Private Key Path: /etc/letsencrypt/live/doro.gitagent.io/privkey.pem

🔍 证书到期时间检查:
检查域名: doro.gitagent.io
  到期时间: Dec  3 04:50:51 2025 GMT
  剩余天数: 89 天
  ✅ 证书状态正常

检查域名: gitagent.io
  到期时间: Nov 19 11:35:34 2025 GMT
  剩余天数: 76 天
  ✅ 证书状态正常

🔄 Cron任务状态:
0 2 * * * /usr/bin/certbot renew --webroot --webroot-path=/var/www/letsencrypt --quiet --post-hook "/bin/systemctl reload nginx"

✅ 监控完成
```

---

## 🔍 SSL证书验证

### 1. HTTPS访问测试

#### 健康检查测试
```bash
curl -I https://doro.gitagent.io/health
```

**测试结果**:
```
HTTP/2 200 
server: nginx/1.28.0
date: Thu, 04 Sep 2025 09:51:53 GMT
content-type: application/octet-stream
content-length: 25
content-type: text/plain
```

#### SSL证书信息验证
```bash
openssl s_client -connect doro.gitagent.io:443 -servername doro.gitagent.io < /dev/null 2>/dev/null | openssl x509 -noout -dates
```

**证书有效期**:
```
notBefore=Sep  4 04:50:52 2025 GMT
notAfter=Dec  3 04:50:51 2025 GMT
```

### 2. 证书续期测试

#### 干运行测试
```bash
sudo certbot renew --dry-run
```

**测试问题**: 
```
Failed to renew certificate doro.gitagent.io with error: Could not bind TCP port 80 because it is already in use by another process on this system (such as a web server).
```

**解决方案**: 使用webroot方法进行续期，避免端口冲突。

---

## 🛠️ 技术细节

### 1. SSL证书类型和配置

#### 证书特性
- **证书类型**: Let's Encrypt ECDSA证书
- **加密算法**: ECDSA (Elliptic Curve Digital Signature Algorithm)
- **有效期**: 90天 (Let's Encrypt标准)
- **自动续期**: 每天凌晨2点检查

#### SSL安全配置
- **协议**: TLSv1.2, TLSv1.3
- **加密套件**: ECDHE-RSA-AES256-GCM-SHA512等高强度加密
- **HSTS**: 启用，max-age=31536000秒
- **安全头**: X-Frame-Options, X-Content-Type-Options, X-XSS-Protection

### 2. 自动续期机制

#### Webroot验证方式
- **验证路径**: `/.well-known/acme-challenge/`
- **根目录**: `/var/www/letsencrypt`
- **优势**: 无需停止Web服务器，零停机续期

#### Cron任务详解
```bash
# 每天凌晨2点执行续期检查
0 2 * * * /usr/bin/certbot renew --webroot --webroot-path=/var/www/letsencrypt --quiet --post-hook "/bin/systemctl reload nginx"
```

**参数说明**:
- `--webroot`: 使用webroot验证方式
- `--webroot-path`: 指定验证文件存放路径
- `--quiet`: 静默模式，只在出错时输出
- `--post-hook`: 续期成功后执行的命令

### 3. 多域名证书管理

#### 当前管理的证书
1. **doro.gitagent.io**: 独立证书，用于OrientDirector项目
2. **gitagent.io**: 主域名证书，包含www.gitagent.io

#### 证书隔离优势
- 独立管理，互不影响
- 不同的续期策略
- 更好的安全隔离

---

## 📋 维护和监控

### 1. 日常监控任务

#### 定期检查项目
1. **证书有效期**: 使用监控脚本检查剩余天数
2. **续期日志**: 检查 `/var/log/letsencrypt/letsencrypt.log`
3. **Nginx状态**: 确保Web服务器正常运行
4. **Cron任务**: 验证自动续期任务正常执行

#### 监控脚本使用
```bash
# 手动执行监控
./ssl_monitor.sh

# 添加到定期任务 (可选)
# 每周一上午9点执行监控报告
0 9 * * 1 /home/ec2-user/ssl_monitor.sh | mail -s "SSL证书状态报告" admin@gitagent.io
```

### 2. 故障排查

#### 常见问题和解决方案

**问题1**: 续期失败 - 端口80被占用
```bash
# 解决方案: 使用webroot方法
sudo certbot renew --webroot --webroot-path=/var/www/letsencrypt
```

**问题2**: 证书路径错误
```bash
# 检查证书路径
sudo certbot certificates

# 更新Nginx配置中的证书路径
sudo nginx -t && sudo systemctl reload nginx
```

**问题3**: Cron任务未执行
```bash
# 检查cron服务状态
sudo systemctl status crond

# 查看cron日志
sudo journalctl -u crond -f
```

### 3. 备份和恢复

#### 证书备份
```bash
# 备份Let's Encrypt目录
sudo tar -czf /backup/letsencrypt-$(date +%Y%m%d).tar.gz /etc/letsencrypt/

# 备份Nginx配置
sudo cp /etc/nginx/conf.d/doro.gitagent.io.conf /backup/doro.gitagent.io.conf.$(date +%Y%m%d)
```

#### 恢复流程
```bash
# 恢复证书文件
sudo tar -xzf /backup/letsencrypt-YYYYMMDD.tar.gz -C /

# 恢复Nginx配置
sudo cp /backup/doro.gitagent.io.conf.YYYYMMDD /etc/nginx/conf.d/doro.gitagent.io.conf

# 重新加载Nginx
sudo nginx -t && sudo systemctl reload nginx
```

---

## 📊 性能和安全

### 1. SSL性能优化

#### 当前配置优化
- **HTTP/2**: 启用，提升传输效率
- **SSL会话缓存**: 10MB共享缓存，10分钟超时
- **OCSP Stapling**: 可进一步配置以提升验证速度

#### 建议的进一步优化
```nginx
# 在server块中添加
ssl_stapling on;
ssl_stapling_verify on;
ssl_trusted_certificate /etc/letsencrypt/live/doro.gitagent.io/chain.pem;
resolver 8.8.8.8 8.8.4.4 valid=300s;
resolver_timeout 5s;
```

### 2. 安全加固

#### 当前安全措施
- **HSTS**: 强制HTTPS访问
- **安全头**: 防止XSS、点击劫持等攻击
- **强加密**: 使用现代加密算法和协议

#### 安全评级
可使用 [SSL Labs](https://www.ssllabs.com/ssltest/) 测试SSL配置评级。

---

## 🔮 未来改进

### 1. 监控增强

#### 建议的监控改进
- **邮件通知**: 证书即将过期时发送邮件
- **Slack集成**: 实时通知证书状态变化
- **Prometheus监控**: 集成到监控系统

#### 监控脚本增强
```bash
# 添加邮件通知功能
if [ $days_left -lt 30 ]; then
    echo "证书即将过期" | mail -s "SSL证书警告" admin@gitagent.io
fi
```

### 2. 自动化改进

#### 建议的自动化功能
- **证书申请自动化**: 新域名自动申请证书
- **配置模板化**: 使用模板生成Nginx配置
- **多环境支持**: 开发、测试、生产环境的证书管理

---

## 📝 总结

### ✅ 已完成的配置

1. **SSL证书申请**: 成功为 `doro.gitagent.io` 申请Let's Encrypt证书
2. **Nginx配置**: 自动更新配置文件，启用HTTPS
3. **自动续期**: 配置Cron任务，每天检查证书续期
4. **监控脚本**: 创建监控工具，实时检查证书状态
5. **安全配置**: 启用HSTS、安全头等安全措施

### 📊 当前状态

- **证书有效期**: 2025年12月3日 (剩余89天)
- **自动续期**: 已配置，每天凌晨2点执行
- **监控状态**: 正常，可手动执行监控脚本
- **HTTPS访问**: 正常，HTTP自动重定向到HTTPS

### 🎯 关键优势

1. **零停机续期**: 使用webroot方法，无需停止服务
2. **多域名支持**: 与现有gitagent.io证书并存
3. **自动化管理**: 无需手动干预的证书续期
4. **安全加固**: 现代SSL配置和安全头
5. **监控完善**: 实时状态检查和日志记录

### 📞 联系信息

- **部署时间**: 2025年9月4日
- **技术支持**: Claude Sonnet 4 AI Assistant
- **项目地址**: https://doro.gitagent.io
- **证书颁发机构**: Let's Encrypt

---

**注意**: 本文档记录了SSL证书配置的完整过程。如需修改配置或遇到问题，请参考相应章节的故障排查指南。
