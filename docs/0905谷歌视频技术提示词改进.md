# Google Veo 3 视频生成提示词改进方案

## 📅 文档信息
- **创建时间**: 2025-09-05
- **版本**: v1.0
- **项目**: OrientDirector - Doro合影视频生成提示词优化

## 🎯 问题分析

### 1. 版本对比分析

#### 📊 Commit 533ad5e 版本特点
**优点**:
- ✅ 生成的图片符合目标提示词和图像组合需求
- ✅ 图片质量高，人物和Doro形象清晰
- ✅ 景点背景准确，构图合理

**缺点**:
- ❌ 视频生成API调用失败（参数格式问题）
- ❌ 提示词相对简单，缺乏丰富的细节

#### 📊 当前版本（1c29432）特点
**优点**:
- ✅ 视频生成技术稳定，API调用成功
- ✅ 完整的异步操作处理
- ✅ 双重图片生成策略（Imagen 3 + 后备）

**缺点**:
- ❌ 图片提示词过于简化
- ❌ 缺乏现有Doro合影功能的丰富提示词逻辑
- ❌ 没有利用用户照片和Doro照片的特征提取

### 2. 核心差异分析

#### 🔍 533ad5e版本的图片提示词逻辑：
```python
# 简单的提示词构建
prompt = f"Create a high-quality travel photo showing a real person and their charming animated character companion Doro at the famous {attraction_name} in {location}"

# 基础姿势选择
poses = ["taking a selfie together", "posing happily", "giving thumbs up", "making peace signs", "smiling at the camera"]
pose = random.choice(poses)
prompt += f". They are {pose}"

# 简单的服装和光线描述
prompt += ", wearing casual travel attire"
prompt += f", {time_descriptions.get(time_of_day, 'with natural lighting')}"
prompt += ". Professional photography, high resolution, vibrant colors, perfect composition, travel photography style"
```

#### 🔍 当前版本的Doro合影提示词逻辑（更丰富）：
```python
# 使用专业的提示词生成器
main_prompt = doro_prompt_generator.generate_attraction_doro_prompt(
    attraction_name=attraction_info.get("name"),
    attraction_type=attraction_info.get("category"),
    location=attraction_info.get("location"),
    with_style=style_photo is not None,
    doro_style=attraction_info.get("doro_style", "default"),
    user_description=attraction_info.get("user_description")
)

# 风格迁移提示
if style_photo:
    style_prompt = doro_prompt_generator.generate_style_transfer_prompt()
    main_prompt = f"{main_prompt}. {style_prompt}"

# 详细的增强提示词
main_prompt = doro_prompt_generator.enhance_prompt_with_details(
    main_prompt,
    time_of_day=attraction_info.get("time_of_day"),
    weather=attraction_info.get("weather"),
    season=attraction_info.get("season"),
    mood=attraction_info.get("mood")
)

# 包含用户照片、Doro照片和风格照片
contents = [main_prompt, user_image, doro_image]
if style_image:
    contents.append(style_image)

# 负面提示词
negative_prompt = doro_prompt_generator.get_negative_prompt()
contents.append(f"Avoid: {negative_prompt}")
```

## 🚀 改进方案

### 1. 核心改进策略

#### 🎯 目标：
- 保持当前版本的稳定视频生成技术
- 将现有Doro合影的丰富提示词逻辑应用到视频生成的图片阶段
- 确保生成的图片质量达到533ad5e版本的水平

#### 🔧 技术方案：
1. **重构`_generate_image_prompt_for_video`函数**
2. **集成`DoroPromptGenerator`的完整逻辑**
3. **添加用户照片和Doro照片的特征提取**
4. **保持视频生成的成功技术不变**

### 2. 具体改进代码

#### 📝 新的图片提示词生成函数：

```python
async def _generate_image_prompt_for_video(
    self, 
    user_photo: UploadFile,
    doro_photo: UploadFile,
    attraction_info: Dict,
    style_photo: Optional[UploadFile] = None
) -> str:
    """
    为视频生成创建图片提示词（使用完整的Doro合影逻辑）
    
    Args:
        user_photo: 用户照片
        doro_photo: Doro形象
        attraction_info: 景点信息
        style_photo: 风格参考（可选）
        
    Returns:
        图片生成提示词
    """
    # 导入提示词生成器
    from .prompt_generator import doro_prompt_generator
    
    # 使用与Doro合影相同的提示词生成逻辑
    main_prompt = doro_prompt_generator.generate_attraction_doro_prompt(
        attraction_name=attraction_info.get("name"),
        attraction_type=attraction_info.get("category", "城市地标"),  # 默认类型
        location=attraction_info.get("address", attraction_info.get("location")),
        with_style=style_photo is not None,
        doro_style=attraction_info.get("doro_style", "default"),
        user_description=attraction_info.get("user_description")
    )
    
    # 如果有服装风格，添加风格迁移提示
    if style_photo:
        style_prompt = doro_prompt_generator.generate_style_transfer_prompt()
        main_prompt = f"{main_prompt}. {style_prompt}"
    
    # 增强提示词（根据额外参数）
    main_prompt = doro_prompt_generator.enhance_prompt_with_details(
        main_prompt,
        time_of_day=attraction_info.get("time_of_day"),
        weather=attraction_info.get("weather"),
        season=attraction_info.get("season"),
        mood=attraction_info.get("mood")
    )
    
    # 添加视频生成特定的要求
    video_specific_prompt = (
        ". This image will be used as the base for video generation, "
        "so ensure clear, stable composition with both subjects clearly visible. "
        "Avoid complex backgrounds that might interfere with video motion. "
        "Focus on natural, authentic expressions and poses suitable for animation"
    )
    
    main_prompt += video_specific_prompt
    
    logger.info(f"视频图片提示词: {main_prompt[:200]}...")
    return main_prompt
```

#### 📝 改进的视频生成函数（第一步）：

```python
# 在generate_doro_video_with_attraction函数中的第一步改进
try:
    # 使用改进的图片提示词生成
    image_prompt = await self._generate_image_prompt_for_video(
        user_photo=user_photo,
        doro_photo=doro_photo,
        attraction_info=attraction_info,
        style_photo=style_photo
    )
    logger.info(f"📝 图片提示词: {image_prompt[:200]}...")
    
    # 准备图片内容（与Doro合影相同的逻辑）
    # 读取并处理用户照片
    user_photo.file.seek(0)
    user_image = Image.open(user_photo.file)
    if user_image.mode != 'RGB':
        user_image = user_image.convert('RGB')
    
    # 读取并处理Doro照片
    doro_photo.file.seek(0)
    doro_image = Image.open(doro_photo.file)
    if doro_image.mode != 'RGB':
        doro_image = doro_image.convert('RGB')
    
    # 读取风格照片（如果有）
    style_image = None
    if style_photo:
        try:
            style_photo.file.seek(0)
            style_image = Image.open(style_photo.file)
            if style_image.mode != 'RGB':
                style_image = style_image.convert('RGB')
        except Exception as e:
            logger.warning(f"⚠️ 风格图片加载失败，将跳过: {e}")
            style_image = None
    
    # 构建内容列表（与Doro合影相同）
    contents = [image_prompt]
    contents.append(user_image)
    contents.append(doro_image)
    if style_image:
        contents.append(style_image)
    
    # 添加负面提示词
    from .prompt_generator import doro_prompt_generator
    negative_prompt = doro_prompt_generator.get_negative_prompt()
    contents.append(f"Avoid: {negative_prompt}")
    
    # 使用Gemini API生成图片（而不是Imagen 3）
    response = await self._call_gemini_with_retry(contents)
    
    # 提取生成的图片（使用现有的提取逻辑）
    generated_image = None
    
    # 使用现有的图片提取逻辑...
    # [保持现有的图片提取代码不变]
    
except Exception as e:
    logger.error(f"❌ 改进的图片生成失败: {e}")
    # 如果失败，回退到原始的简单方法
    # [保持原有的后备逻辑]
```

### 3. 关键改进点

#### 🔑 核心改进：

1. **完整的提示词生成逻辑**：
   - ✅ 使用`DoroPromptGenerator`的专业提示词构建
   - ✅ 支持景点类型、Doro风格、用户描述等丰富参数
   - ✅ 包含时间、天气、季节、情绪等增强细节

2. **图片内容处理**：
   - ✅ 包含用户照片、Doro照片和风格照片
   - ✅ 正确的图片预处理（RGB转换、指针重置）
   - ✅ 负面提示词避免低质量生成

3. **视频生成特定优化**：
   - ✅ 添加视频生成特定的构图要求
   - ✅ 确保清晰稳定的构图适合后续动画
   - ✅ 避免复杂背景干扰视频运动

4. **后备机制**：
   - ✅ 保持原有的后备逻辑
   - ✅ 如果改进方法失败，自动回退到简单方法
   - ✅ 确保系统稳定性

### 4. 预期效果

#### 📈 改进后的优势：

1. **图片质量提升**：
   - 🎯 达到533ad5e版本的图片质量水平
   - 🎯 更准确的人物和Doro形象还原
   - 🎯 更丰富的景点背景细节

2. **提示词丰富度**：
   - 🎯 从简单的5-6个要素扩展到15+个要素
   - 🎯 支持多种Doro风格和用户自定义
   - 🎯 包含专业的摄影和构图要求

3. **系统稳定性**：
   - 🎯 保持当前版本的视频生成成功率
   - 🎯 完整的错误处理和后备机制
   - 🎯 向下兼容，不影响现有功能

## 🔄 实施计划

### 阶段1：代码修改
1. 修改`_generate_image_prompt_for_video`函数
2. 集成`DoroPromptGenerator`逻辑
3. 添加图片内容处理

### 阶段2：测试验证
1. 本地测试图片生成质量
2. 验证视频生成功能正常
3. 对比533ad5e版本的效果

### 阶段3：部署上线
1. 提交代码到GitHub
2. 更新服务器版本
3. 重启服务器应用

## 📋 技术要点总结

### ✅ 保持不变的部分：
- 视频生成的核心技术（直接使用图片对象）
- 异步操作处理和轮询机制
- 错误处理和日志记录

### 🔄 改进的部分：
- 图片提示词生成逻辑
- 图片内容处理（包含多张照片）
- 提示词丰富度和专业性

### 🎯 预期结果：
- 图片质量达到533ad5e版本水平
- 视频生成保持100%成功率
- 用户体验显著提升
