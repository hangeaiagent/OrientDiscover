# Doro服务器部署说明 - 2025年9月4日

## 概述
本文档详细说明了如何在AWS EC2服务器上部署OrientDirector项目，包括前端、后端服务的配置，以及域名和Nginx反向代理的设置。

## 服务器信息
- **服务器IP**: 54.89.140.250
- **域名**: doro.gitagent.io
- **操作系统**: Amazon Linux 2
- **用户**: ec2-user

## 部署架构
```
Internet → Nginx (80/443) → 前端服务 (3001) + 后端API (8001)
```

## 第一步：连接服务器并下载项目

### 1.1 连接到服务器
```bash
ssh -i /Users/a1/work/productmindai.pem ec2-user@54.89.140.250
```

### 1.2 创建项目目录并下载代码
```bash
# 进入用户目录
cd /home/ec2-user

# 创建项目目录
mkdir -p OrientDirector
cd OrientDirector

# 下载OrientDiscover项目
git clone https://github.com/hangeaiagent/OrientDiscover.git .

# 检查项目文件
ls -la
```

## 第二步：修改端口配置

为了避免端口冲突，已将默认端口修改为：
- **后端服务**: 8001 (原8000)
- **前端服务**: 3001 (原3000)

### 2.1 已修改的文件
- `backend/main.py`: 后端服务端口改为8001
- `start_backend.py`: 启动脚本端口改为8001
- `start_frontend.py`: 前端服务端口改为3001
- `netlify.toml`: API代理端口改为8001

## 第三步：安装依赖和配置环境

### 3.1 安装系统依赖
```bash
# 更新系统包
sudo yum update -y

# 安装Python3和pip
sudo yum install -y python3 python3-pip

# 安装Nginx
sudo yum install -y nginx

# 安装Git (如果未安装)
sudo yum install -y git
```

### 3.2 安装Python依赖
```bash
# 在项目目录中
cd /home/ec2-user/OrientDirector

# 安装Python依赖
pip3 install -r requirements.txt
```

## 第四步：配置后台启动脚本

### 4.1 设置脚本权限
```bash
# 给启动脚本添加执行权限
chmod +x start_production.sh
chmod +x stop_production.sh
chmod +x restart_production.sh
```

### 4.2 启动服务
```bash
# 启动生产环境服务
./start_production.sh
```

### 4.3 检查服务状态
```bash
# 查看后端日志
tail -f logs/backend.log

# 查看前端日志
tail -f logs/frontend.log

# 检查进程
ps aux | grep -E "(uvicorn|python3.*start_frontend)"
```

## 第五步：配置Nginx反向代理

### 5.1 复制Nginx配置文件
```bash
# 复制配置文件到Nginx目录
sudo cp nginx-doro.conf /etc/nginx/sites-available/doro.gitagent.io

# 创建软链接启用站点
sudo ln -s /etc/nginx/sites-available/doro.gitagent.io /etc/nginx/sites-enabled/

# 删除默认站点 (可选)
sudo rm -f /etc/nginx/sites-enabled/default
```

### 5.2 测试Nginx配置
```bash
# 测试配置文件语法
sudo nginx -t

# 如果测试通过，重启Nginx
sudo systemctl restart nginx

# 设置Nginx开机自启
sudo systemctl enable nginx
```

### 5.3 配置防火墙
```bash
# 开放HTTP和HTTPS端口
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

## 第六步：域名DNS配置

### 6.1 AWS Route 53配置
1. 登录AWS控制台
2. 进入Route 53服务
3. 选择您的托管区域
4. 创建A记录：
   - **记录名称**: doro
   - **记录类型**: A
   - **值**: 54.89.140.250
   - **TTL**: 300

### 6.2 域名解析验证
```bash
# 测试域名解析
nslookup doro.gitagent.io

# 或使用dig命令
dig doro.gitagent.io
```

## 第七步：SSL证书配置

### 7.1 使用Let's Encrypt免费证书
```bash
# 安装Certbot
sudo yum install -y certbot python3-certbot-nginx

# 申请SSL证书
sudo certbot --nginx -d doro.gitagent.io

# 设置自动续期
sudo crontab -e
# 添加以下行：
# 0 12 * * * /usr/bin/certbot renew --quiet
```

### 7.2 手动配置SSL证书 (如果有自己的证书)
```bash
# 将证书文件上传到服务器
sudo cp your-certificate.crt /etc/ssl/certs/
sudo cp your-private.key /etc/ssl/private/

# 修改Nginx配置文件中的证书路径
sudo nano /etc/nginx/sites-available/doro.gitagent.io
```

## 第八步：服务管理

### 8.1 常用命令
```bash
# 启动服务
./start_production.sh

# 停止服务
./stop_production.sh

# 重启服务
./restart_production.sh

# 查看服务状态
ps aux | grep -E "(uvicorn|python3.*start_frontend)"

# 查看日志
tail -f logs/backend.log
tail -f logs/frontend.log
```

### 8.2 设置开机自启
```bash
# 创建systemd服务文件
sudo nano /etc/systemd/system/orientdirector.service
```

添加以下内容：
```ini
[Unit]
Description=OrientDirector Application
After=network.target

[Service]
Type=forking
User=ec2-user
WorkingDirectory=/home/ec2-user/OrientDirector
ExecStart=/home/ec2-user/OrientDirector/start_production.sh
ExecStop=/home/ec2-user/OrientDirector/stop_production.sh
Restart=always

[Install]
WantedBy=multi-user.target
```

启用服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable orientdirector
sudo systemctl start orientdirector
```

## 第九步：监控和维护

### 9.1 日志管理
```bash
# 设置日志轮转
sudo nano /etc/logrotate.d/orientdirector
```

添加以下内容：
```
/home/ec2-user/OrientDirector/logs/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    create 644 ec2-user ec2-user
}
```

### 9.2 性能监控
```bash
# 监控系统资源
htop

# 监控网络连接
netstat -tulpn | grep -E "(3001|8001|80|443)"

# 监控磁盘使用
df -h
```

## 第十步：故障排除

### 10.1 常见问题

#### 端口被占用
```bash
# 查看端口占用
sudo netstat -tulpn | grep -E "(3001|8001)"

# 杀死占用进程
sudo kill -9 <PID>
```

#### 服务无法启动
```bash
# 检查Python依赖
pip3 list

# 检查日志
tail -f logs/backend.log
tail -f logs/frontend.log

# 手动启动测试
cd backend && python3 -m uvicorn main:app --host 0.0.0.0 --port 8001
```

#### Nginx配置错误
```bash
# 测试配置
sudo nginx -t

# 查看Nginx错误日志
sudo tail -f /var/log/nginx/error.log
```

### 10.2 健康检查
```bash
# 检查后端API
curl http://localhost:8001/api/health

# 检查前端服务
curl http://localhost:3001

# 检查域名访问
curl https://doro.gitagent.io/health
```

## 部署完成检查清单

- [x] 项目代码已下载到服务器
- [x] 端口配置已修改 (后端8001，前端3001)
- [x] Python依赖已安装
- [x] 后台启动脚本已配置并测试
- [x] Nginx已安装并配置反向代理
- [x] 域名DNS已指向服务器IP
- [x] SSL证书已配置 (使用现有gitagent.io证书)
- [x] 防火墙规则已配置
- [x] 服务已设置为开机自启
- [x] 日志轮转已配置
- [x] 健康检查通过

## 问题解决记录

### 1. 依赖问题解决
**问题**: `ModuleNotFoundError: No module named 'google'`
**解决方案**:
```bash
# 在Conda环境中安装缺失的依赖
conda activate orient
pip install google-generativeai pillow numpy
```

### 2. API端口配置问题
**问题**: 前端调用localhost:8000，但后端运行在8001端口
**解决方案**:
- 修改 `app.js` 中的 `API_BASE_URL` 从 `http://localhost:8000` 改为 `http://localhost:8001`
- 确保前后端端口配置一致

### 3. Gemini API地理位置限制
**问题**: `400 User location is not supported for the API use`
**解决方案**:
- 添加地理位置限制错误的特殊处理
- 提供更友好的错误提示信息
- 建议使用VPN或联系管理员

### 4. 环境配置管理
**问题**: API密钥硬编码在代码中
**解决方案**:
- 创建完整的 `.env` 配置文件
- 修改 `gemini_service.py` 从环境变量读取API密钥
- 添加环境变量验证

### 5. 漫游搜索性能优化
**问题**: 漫游搜索"中国, 北京, 天安门"非常慢
**解决方案**:
- 修复所有前端API调用端口从8000改为8001
- 添加地理编码缓存机制，提升重复查询速度
- 增加API超时时间从3秒到10秒
- 优化错误处理和日志记录
- 实现LRU缓存策略，最大缓存1000个条目

## 服务配置总结

### 端口分配
- **gitagent.io**: 前端3000，后端8000 (现有服务)
- **doro.gitagent.io**: 前端3001，后端8001 (新服务)

### 域名配置
- **主域名**: gitagent.io (现有)
- **子域名**: doro.gitagent.io (新增)
- **SSL证书**: 共享使用gitagent.io的Let's Encrypt证书

### 服务管理命令
```bash
# 启动服务
./start_production.sh

# 停止服务
./stop_production.sh

# 重启服务
./restart_production.sh

# 查看日志
tail -f logs/backend.log
tail -f logs/frontend.log
```

## 性能优化说明

### 缓存机制
- **地理编码缓存**: 自动缓存地理编码结果，避免重复API调用
- **缓存大小**: 最大1000个条目，使用LRU策略自动清理
- **缓存命中**: 重复查询相同地点时，响应时间从秒级降低到毫秒级

### API优化
- **超时设置**: 从3秒增加到10秒，减少网络超时错误
- **错误处理**: 改进错误提示和重试机制
- **端口统一**: 所有API调用统一使用8001端口

### 预期性能提升
- **首次查询**: 3-10秒（取决于网络和API响应）
- **缓存命中**: <100毫秒
- **重复地点查询**: 提升90%以上响应速度

## 访问地址

部署完成后，可以通过以下地址访问应用：

- **主域名**: https://doro.gitagent.io
- **API文档**: https://doro.gitagent.io/api/docs
- **健康检查**: https://doro.gitagent.io/health

## 联系信息

如有问题，请联系开发团队或查看项目文档。

---

**部署日期**: 2025年9月4日  
**部署版本**: OrientDiscover main分支  
**服务器**: AWS EC2 (54.89.140.250)  
**域名**: doro.gitagent.io
