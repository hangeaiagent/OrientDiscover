# Google Veo 3 视频生成技术文档

## 📅 文档信息
- **创建时间**: 2025-09-05
- **最后更新**: 2025-09-05
- **版本**: v1.0
- **作者**: AI Assistant

## 🎯 概述

本文档总结了在OrientDirector项目中集成Google Veo 3 API进行视频生成的技术要点、问题解决过程和最佳实践。

## 🔧 核心技术实现

### 1. API调用格式

#### ✅ 正确的图片参数格式
```python
from google.genai import types
import base64
from io import BytesIO

# 将PIL图片转换为base64格式
buffered = BytesIO()
static_image.save(buffered, format="PNG")
buffered.seek(0)
image_bytes = buffered.getvalue()
image_base64 = base64.b64encode(image_bytes).decode('utf-8')
buffered.close()

# 使用Part.from_dict创建正确的图片参数格式
image_part = types.Part.from_dict({
    "inline_data": {
        "mime_type": "image/png",
        "data": image_base64
    }
})

# 调用Veo 3生成视频
operation = client.models.generate_videos(
    model="veo-3.0-generate-preview",
    prompt=video_prompt,
    image=image_part,  # 使用Part对象
)
```

#### ❌ 错误的格式（已修复）
```python
# 错误1：直接传递字典
image_dict = {
    "bytesBase64Encoded": image_base64,
    "mimeType": "image/png"
}

# 错误2：直接传递PIL Image对象
operation = client.models.generate_videos(
    model="veo-3.0-generate-preview",
    prompt=video_prompt,
    image=static_image,  # 直接传递PIL对象 - 不被接受
)

# 错误3：使用Blob格式
image_blob = types.Blob(
    mime_type="image/png",
    data=image_bytes
)
```

### 2. 异步操作处理

```python
from google.genai import types
import time

# 启动视频生成作业
operation = client.models.generate_videos(
    model="veo-3.0-generate-preview",
    prompt=video_prompt,
    image=image_part,
)

logger.info(f"🎬 视频生成作业已启动: {operation.name}")
video_operation = types.GenerateVideosOperation(name=operation.name)

# 轮询操作状态
max_wait_time = 600  # 最多等待10分钟
start_time = time.time()

while not video_operation.done:
    if time.time() - start_time > max_wait_time:
        raise TimeoutError("视频生成超时")
    
    logger.info("⏳ 视频生成中，等待10秒后检查状态...")
    time.sleep(10)
    video_operation = client.operations.get(video_operation)

# 获取生成结果
if video_operation.response and video_operation.response.generated_videos:
    generated_video = video_operation.response.generated_videos[0]
    # 处理视频文件...
```

## 🚨 常见错误及解决方案

### 1. Pydantic验证错误
**错误信息**:
```
1 validation error for _GenerateVideosParameters
image.bytesBase64Encoded
  Extra inputs are not permitted [type=extra_forbidden]
```

**原因**: API不接受直接的字典格式，需要使用`Part.from_dict`创建正确的嵌套结构。

**解决方案**: 使用`types.Part.from_dict`创建`inline_data`结构。

### 2. API参数格式错误
**错误信息**:
```
400 INVALID_ARGUMENT. Input instance with `image` should contain both `bytesBase64Encoded` and `mimeType` in underlying struct value.
```

**原因**: 图片参数格式不符合API要求。

**解决方案**: 使用正确的`inline_data`格式，包含`mime_type`和`data`字段。

### 3. 异步操作未等待
**错误信息**:
```
RuntimeWarning: coroutine 'function_name' was never awaited
```

**原因**: 异步函数调用时缺少`await`关键字。

**解决方案**: 在调用异步函数时添加`await`。

## 📋 技术要点总结

### 1. 图片处理要点
- ✅ 使用PIL Image对象处理图片
- ✅ 转换为PNG格式（`format="PNG"`）
- ✅ 使用base64编码（`base64.b64encode().decode('utf-8')`）
- ✅ 正确设置mime_type为`"image/png"`

### 2. API调用要点
- ✅ 使用`google.genai.types.Part.from_dict`创建图片参数
- ✅ 使用`inline_data`结构包装图片数据
- ✅ 模型名称：`"veo-3.0-generate-preview"`
- ✅ 异步操作需要轮询检查状态

### 3. 错误处理要点
- ✅ 实现重试机制（最多3次）
- ✅ 设置合理的超时时间（10分钟）
- ✅ 详细的日志记录
- ✅ 友好的错误信息提示

## 🔄 完整的视频生成流程

```python
async def generate_doro_video_with_attraction(self, user_photo, doro_photo, attraction_info, style_photo=None):
    """
    生成Doro合影视频的完整流程
    """
    try:
        # 第一步：生成静态合影图片（使用现有的Doro合影逻辑）
        success, message, image_result = await self.generate_doro_selfie_with_attraction(
            user_photo=user_photo,
            doro_photo=doro_photo,
            attraction_info=attraction_info,
            style_photo=style_photo
        )
        
        if not success:
            return False, f"静态图片生成失败: {message}", None
            
        # 从base64数据创建图片对象
        image_base64 = image_result['image_url'].split(',')[1]
        image_data = base64.b64decode(image_base64)
        static_image = Image.open(BytesIO(image_data))
        
        # 第二步：使用Veo 3生成视频
        logger.info("🎬 第二步：使用Veo 3生成动态视频...")
        
        # 生成视频提示词
        video_prompt = self._generate_video_prompt(
            attraction_info, 
            (1024, 1024),
            image_prompt=image_result.get('prompt_used', '')
        )
        
        # 将PIL图片转换为Veo 3 API要求的格式
        buffered = BytesIO()
        static_image.save(buffered, format="PNG")
        buffered.seek(0)
        image_bytes = buffered.getvalue()
        image_base64 = base64.b64encode(image_bytes).decode('utf-8')
        buffered.close()
        
        # 使用Part.from_dict创建正确的图片参数格式
        from google.genai import types
        image_part = types.Part.from_dict({
            "inline_data": {
                "mime_type": "image/png",
                "data": image_base64
            }
        })
        
        # 调用Veo 3生成视频
        operation = client.models.generate_videos(
            model="veo-3.0-generate-preview",
            prompt=video_prompt,
            image=image_part,
        )
        
        # 轮询等待视频生成完成
        video_operation = types.GenerateVideosOperation(name=operation.name)
        max_wait_time = 600  # 10分钟
        start_time = time.time()
        
        while not video_operation.done:
            if time.time() - start_time > max_wait_time:
                return False, "视频生成超时，请稍后重试", None
            
            time.sleep(10)
            video_operation = client.operations.get(video_operation)
        
        # 处理生成结果
        if video_operation.response and video_operation.response.generated_videos:
            generated_video = video_operation.response.generated_videos[0]
            
            # 下载并保存视频
            video_data = client.files.download(file=generated_video.video)
            
            # 保存视频文件
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            attraction_name_clean = re.sub(r'[^\w\u4e00-\u9fff]', '', attraction_info.get('name', '景点'))
            video_filename = f"doro_video_{attraction_name_clean}_{timestamp}.mp4"
            video_path = os.path.join("backend/generated_videos", video_filename)
            
            os.makedirs(os.path.dirname(video_path), exist_ok=True)
            with open(video_path, 'wb') as f:
                f.write(video_data)
            
            # 转换为base64用于前端显示
            video_base64 = base64.b64encode(video_data).decode('utf-8')
            video_data_url = f"data:video/mp4;base64,{video_base64}"
            
            return True, "视频生成成功", {
                'video_url': video_data_url,
                'video_path': video_path,
                'video_filename': video_filename,
                'prompt_used': video_prompt
            }
        else:
            return False, "视频生成失败，未获取到结果", None
            
    except Exception as e:
        logger.error(f"生成Doro合影视频时出错: {str(e)}")
        return False, f"视频生成失败: {str(e)}", None
```

## 🛠️ 开发环境配置

### 1. 依赖包
```txt
google-genai>=0.1.0
google-generativeai>=0.3.0
pillow>=9.0.0
```

### 2. 环境变量
```bash
GEMINI_API_KEY=your_api_key_here
```

### 3. Nginx配置（视频生成超时优化）
```nginx
location /api/doro/generate-video {
    proxy_pass http://127.0.0.1:8001;
    proxy_read_timeout 900s;  # 15分钟
    proxy_connect_timeout 60s;
    proxy_send_timeout 900s;
    # ... 其他配置
}
```

## 📊 性能优化建议

1. **超时设置**: 视频生成通常需要5-10分钟，设置合理的超时时间
2. **错误重试**: 实现指数退避重试机制
3. **缓存策略**: 考虑对相同参数的请求进行缓存
4. **异步处理**: 使用异步操作避免阻塞
5. **资源清理**: 及时清理临时文件和内存

## 🔍 调试技巧

1. **日志记录**: 详细记录每个步骤的执行情况
2. **参数验证**: 在API调用前验证所有参数
3. **错误分类**: 区分网络错误、API错误和业务逻辑错误
4. **状态监控**: 实时监控视频生成进度

## 📝 更新历史

- **2025-09-05**: 初始版本，包含完整的技术实现和问题解决方案
- **修复记录**: 
  - 解决Pydantic验证错误
  - 修复API参数格式问题
  - 优化异步操作处理
  - 完善错误处理机制

## 🔗 相关文档

- [Google Veo 3 API官方文档](https://ai.google.dev/gemini-api/docs/video)
- [Google GenAI Python SDK](https://github.com/google/generative-ai-python)
- [OrientDirector部署文档](./doro服务器部署说明0904.md)
