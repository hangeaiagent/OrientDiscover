# 🚀 OrientDiscover 本地启动指南

## 环境要求

- **Python 3.9**（必须使用 Python 3.9，避免兼容性问题）
- Git
- Conda（推荐）或 venv
- 现代浏览器（Chrome、Firefox、Safari 等）
- macOS/Linux 系统（支持 `lsof` 命令）

## 快速启动步骤

### 1. 克隆项目

```bash
git clone https://github.com/hangeaiagent/OrientDiscover.git
cd OrientDiscover
```

### 2. 创建虚拟环境

#### 使用 Conda（推荐）
```bash
# 创建 Python 3.9 环境
conda create -n orient python=3.9 -y

# 激活环境
conda activate orient
```

#### 使用 venv（备选）
```bash
# 创建虚拟环境
python3.9 -m venv orient_env

# 激活环境
source orient_env/bin/activate  # macOS/Linux
# 或
orient_env\Scripts\activate     # Windows
```



### 3. 安装依赖

```bash
# 安装Python依赖
pip install -r requirements.txt

# 安装PyJWT（如果requirements.txt中没有）
pip install PyJWT

# 安装其他必要依赖
pip install fastapi uvicorn python-multipart
```

### 4. 环境配置

#### 设置本地环境变量
```bash
# 设置为本地开发环境
export isUsedomainnameaddress=false

# 或者使用配置脚本
./set_environment.sh local
```

### 5. 启动服务

#### 方式一：统一启动（推荐）

```bash
# 同时启动前后端服务
python start_all.py
```

#### 方式二：分别启动

**启动后端服务：**
```bash
python start_backend.py
```

**新开终端，启动前端服务：**
```bash
python start_frontend.py
```

#### 方式三：手动启动

**启动后端服务（在项目根目录）：**
```bash
cd backend
python -m uvicorn main:app --host 0.0.0.0 --port 8001 --reload
```

**新开终端，启动前端服务（在项目根目录）：**
```bash
python start_frontend.py
```

## 访问应用

- **前端地址**：http://localhost:3001
- **后端 API**：http://localhost:8001
- **API 文档**：http://localhost:8001/docs
- **环境配置页面**：http://localhost:3001/environment_config.html

## 服务端口说明

| 服务 | 端口 | 说明 |
|------|------|------|
| 前端 | 3001 | 静态文件服务器 |
| 后端 | 8001 | FastAPI 服务器 |
| 日志目录 | logs/ | 后端日志文件 |

## 环境配置说明

### 本地开发环境
- **环境变量**：`isUsedomainnameaddress=false`
- **API_BASE_URL**：`http://localhost:8001`
- **用途**：本地开发和调试

### 生产环境
- **环境变量**：`isUsedomainnameaddress=true`
- **API_BASE_URL**：`https://doro.gitagent.io`
- **用途**：生产部署

### 环境切换方法

#### 方法1：使用配置脚本
```bash
# 切换到本地环境
./set_environment.sh local

# 切换到生产环境
./set_environment.sh production

# 查看当前状态
./set_environment.sh status
```

#### 方法2：浏览器控制台
```javascript
// 切换到本地环境
EnvironmentConfig.setUseDomainName(false);

// 切换到生产环境
EnvironmentConfig.setUseDomainName(true);

// 查看当前状态
EnvironmentConfig.showStatus();
```

#### 方法3：可视化界面
访问 `http://localhost:3001/environment_config.html` 进行图形化配置

## 常见问题

### 1. 端口被占用

**问题**：启动时提示端口被占用

**解决方案**：
```bash
# 自动清理端口（推荐）
python start_all.py

# 手动清理端口
lsof -ti :8001 | xargs kill -9
lsof -ti :3001 | xargs kill -9

# 查看端口占用情况
lsof -i :8001
lsof -i :3001
```

### 2. 后端启动失败

**问题**：`ModuleNotFoundError: No module named 'jwt'`

**解决方案**：
```bash
# 安装缺失的依赖
pip install PyJWT

# 安装所有依赖
pip install -r requirements.txt
```

### 3. 环境配置问题

**问题**：API调用失败或连接错误

**解决方案**：
```bash
# 检查当前环境配置
./set_environment.sh status

# 设置为本地环境
./set_environment.sh local

# 刷新页面重新加载配置
```

### 4. 方向获取失败

**问题**：应用无法自动获取设备方向

**解决方案**：
- 等待 1 秒后会自动显示手动输入框
- 点击指南针任意位置设置方向
- 或在输入框中输入方向角度（0-359°）

### 5. 位置权限被拒绝

**问题**：浏览器拒绝位置访问

**解决方案**：
1. 检查浏览器设置，允许 localhost:3001 访问位置
2. 刷新页面重新授权
3. 使用 HTTPS 环境（生产环境）

### 6. Python 版本问题

**问题**：`ModuleNotFoundError` 或兼容性错误

**解决方案**：
```bash
# 检查 Python 版本
python --version

# 确保使用 Python 3.9
conda create -n orient python=3.9 -y
conda activate orient
```

## 开发调试

### 查看日志

- **前端日志**：浏览器开发者工具控制台
- **后端日志**：`logs/backend.log` 文件
- **应用内日志**：页面底部的日志面板

### 实时查看后端日志
```bash
# 实时查看后端日志
tail -f logs/backend.log

# 查看完整日志
cat logs/backend.log
```

### 测试 API

```bash
# 健康检查
curl http://localhost:8001/api/health

# 环境配置检查
curl http://localhost:8001/api/config/environment

# 测试探索功能
curl -X POST http://localhost:8001/api/explore-real \
  -H "Content-Type: application/json" \
  -d '{
    "latitude": 40.0,
    "longitude": 116.0,
    "heading": 90,
    "segment_distance": 10,
    "time_mode": "present"
  }'
```

### 清理缓存

```bash
# 删除 API 响应缓存
rm backend/data_cache.json

# 清理 Python 缓存
find . -type d -name __pycache__ -exec rm -r {} +

# 清理日志文件
rm -f logs/*.log logs/*.pid
```

## 停止服务

### 优雅停止
- **Ctrl+C**：在各个终端中停止对应的服务

### 强制停止
```bash
# 查找并停止 Python 进程
pkill -f "uvicorn"
pkill -f "python.*frontend"

# 或者使用端口清理
lsof -ti :8001 | xargs kill -9
lsof -ti :3001 | xargs kill -9
```

### 检查服务状态
```bash
# 检查端口占用
lsof -i :8001
lsof -i :3001

# 检查进程状态
ps aux | grep uvicorn
ps aux | grep python
```

## 快速启动命令

### 一键启动（推荐）
```bash
# 1. 激活环境
conda activate orient

# 2. 设置本地环境
export isUsedomainnameaddress=false

# 3. 启动所有服务
python start_all.py
```

### 分步启动
```bash
# 1. 激活环境
conda activate orient

# 2. 设置本地环境
export isUsedomainnameaddress=false

# 3. 启动后端
python start_backend.py

# 4. 新开终端，启动前端
python start_frontend.py
```

## 部署建议

本地开发完成后，建议：
1. 使用 HTTPS 环境（方向 API 需要）
2. 配置环境变量管理 API 密钥
3. 使用进程管理器（如 PM2）管理服务
4. 配置反向代理（Nginx）统一入口

## 相关文档

- [本地开发及服务器部署状态变量](./0904本地开发及服务器部署状态变量.md)
- [方向问题修改](./方向问题修改.md)
- [高德地图 API 集成](../AMAP_API_INTEGRATION.md)
- [API 密钥设置](../API_KEYS_SETUP.md)

---

## 📋 总结

### ✅ 已完成的配置
1. **端口统一**：前端3001，后端8001
2. **环境管理**：支持本地/生产环境切换
3. **自动启动**：智能端口清理和进程管理
4. **日志系统**：完整的日志记录和管理
5. **依赖管理**：Python 3.9 + 必要依赖

### 🚀 启动方式
- **推荐**：`python start_all.py`（一键启动）
- **备选**：分别启动前后端服务
- **手动**：直接使用uvicorn命令

### 🔧 环境配置
- **本地开发**：`isUsedomainnameaddress=false`
- **生产环境**：`isUsedomainnameaddress=true`
- **切换方式**：脚本、控制台、可视化界面

**最后更新**：2025年9月6日  
**技术支持**：Claude Sonnet 4 AI Assistant
