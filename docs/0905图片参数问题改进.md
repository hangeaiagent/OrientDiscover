# Google Veo 3 视频生成图片参数问题分析与改进建议

## 问题分析

### 当前代码问题

在 `backend/gemini_service.py` 的 `generate_doro_video_with_attraction` 方法中，当前使用的图片参数格式：

```python
# 当前有问题的实现 (第946-958行)
operation = client.models.generate_videos(
    model="veo-3.0-generate-preview",
    prompt=video_prompt,
    image={
        "bytesBase64Encoded": image_base64,
        "mimeType": "image/png",
    },
    config=types.GenerateVideosConfig(
        aspect_ratio="16:9",
    ),
)
```

### 问题根源

1. **参数格式错误**：使用了字典格式 `{"bytesBase64Encoded": ..., "mimeType": ...}`
2. **API不兼容**：Veo 3 API期望的是原始图片对象，而不是手动构造的字典
3. **数据转换冗余**：先保存PNG文件，再读取转base64，增加了不必要的I/O操作

## 正确的实现方案

### 方案一：Imagen 3 主路径（推荐）

```python
try:
    # 主路径：使用 Imagen 3 生成静态图片，并直接传原始 image 对象
    logger.info("🎨 使用 Imagen 3 生成静态图片（主路径）...")
    imagen_response = client.models.generate_images(
        model="imagen-3.0-generate-002",
        prompt=image_prompt,
    )
    if not imagen_response.generated_images:
        raise Exception("Imagen未生成图片")
    
    # 直接使用 Imagen 返回的原始图片对象
    generated_image = imagen_response.generated_images[0].image
    logger.info("✅ Imagen 3 静态图片生成成功")
    
    # 保存一份到磁盘，便于前端展示与排查
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    safe_name = "".join(c for c in attraction_info.get('name', 'unknown') if c.isalnum() or c in ('_', '-'))[:30]
    imagen_filename = f"imagen_{safe_name}_{timestamp}.png"
    imagen_filepath = os.path.join(self.output_dir, imagen_filename)
    
    if hasattr(generated_image, 'save'):
        generated_image.save(imagen_filepath)
    elif hasattr(generated_image, 'data'):
        with open(imagen_filepath, 'wb') as f:
            f.write(generated_image.data)
    
    with open(imagen_filepath, 'rb') as f:
        img_data = f.read()
    img_base64 = base64.b64encode(img_data).decode()
    
    image_result = {
        'image_url': f"data:image/png;base64,{img_base64}",
        'filename': imagen_filename,
        'filepath': imagen_filepath
    }

except Exception as e:
    logger.error(f"❌ Imagen生成失败，走降级路径: {e}")
    # 降级路径：使用现有合影生成方法
```

### 方案二：降级路径（Part inline_data结构）

```python
# 降级路径：使用现有合影生成（含用户与Doro参照图），并以 SDK Part inline_data 结构传入视频接口
logger.info("📸 使用合影生成（含参照图片）作为降级路径...")
success, message, image_result = await self.generate_doro_selfie_with_attraction(
    user_photo=user_photo,
    doro_photo=doro_photo,
    style_photo=style_photo,
    attraction_info=attraction_info
)
if not success:
    return False, f"图片生成失败: {message}", None

# 将合影的 base64 包装为 Part inline_data（注意下划线命名）
from google.genai import types
image_base64 = image_result['image_url'].split(',')[1]
generated_image = types.Part.from_dict({
    "inline_data": {
        "mime_type": "image/png",
        "data": image_base64
    }
})
```

### 统一的视频生成调用

```python
# 第二步：使用Veo 3生成视频
logger.info("🎬 第二步：使用Veo 3生成动态视频...")

# 生成视频提示词（传递图片提示词以保持一致性）
video_prompt = self._generate_video_prompt(
    attraction_info, 
    (1024, 1024),
    image_prompt=image_prompt  # 传递图片提示词
)
logger.info(f"🎬 视频提示词: {video_prompt[:200]}...")

# 调用Veo 3生成视频，使用正确的图片对象格式
operation = client.models.generate_videos(
    model="veo-3.0-generate-preview",
    prompt=video_prompt,
    image=generated_image,  # 直接使用图片对象，无论是Imagen还是Part格式
    config=types.GenerateVideosConfig(
        aspect_ratio="16:9",
    ),
)
```

## 关键改进点

### 1. 图片对象格式统一

- **主路径**：直接使用 `imagen_response.generated_images[0].image`
- **降级路径**：使用 `types.Part.from_dict()` 包装base64数据

### 2. 避免手动构造字典

❌ **错误做法**：
```python
image={
    "bytesBase64Encoded": image_base64,
    "mimeType": "image/png",
}
```

✅ **正确做法**：
```python
image=generated_image  # 直接传递图片对象
```

### 3. 双重策略保障

- **主路径**：Imagen 3直接生成 → 原始对象传递
- **降级路径**：现有合影生成 → Part.from_dict包装

### 4. 错误处理优化

```python
try:
    # 主路径：Imagen 3
    generated_image = imagen_response.generated_images[0].image
except Exception as e:
    logger.error(f"❌ Imagen生成失败，走降级路径: {e}")
    # 降级路径：现有方法 + Part包装
```

## 技术要点总结

### API兼容性

1. **Veo 3期望格式**：原始图片对象或正确的SDK类型
2. **不支持格式**：手动构造的字典结构
3. **SDK版本锁定**：
   - `google-generativeai==0.8.5`
   - `google-genai==1.33.0`

### 数据流优化

```
用户输入 → Imagen 3生成 → 原始对象 → Veo 3视频
       ↓ (失败时)
       → 现有合影生成 → base64提取 → Part包装 → Veo 3视频
```

### 性能优化

- 减少不必要的文件I/O操作
- 避免重复的base64编解码
- 直接使用API返回的原始对象

## 实施建议

### 立即修改

1. 将当前的字典格式改为双重策略
2. 添加Imagen 3主路径
3. 保留现有方法作为降级路径

### 测试验证

1. 测试Imagen 3主路径的成功率
2. 验证降级路径的兼容性
3. 确认视频生成质量

### 监控指标

- Imagen 3成功率
- 降级路径使用频率
- 整体视频生成成功率
- 生成时间对比

## 预期效果

1. **提高成功率**：双重策略保障
2. **减少错误**：避免API参数格式问题
3. **提升性能**：减少不必要的数据转换
4. **增强稳定性**：主路径+降级路径的容错机制

---

**更新时间**：2025-09-05  
**版本**：v1.0  
**状态**：待实施
