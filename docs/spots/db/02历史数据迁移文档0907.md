# Spot地图相册系统 - 历史数据迁移文档

**创建时间**: 2024-12-13  
**版本**: v1.0  
**作者**: AI Assistant  

## 概述

本文档详细描述了将现有`local_attractions_db.py`和`global_cities_db.py`中的景点数据迁移到Supabase数据库的完整过程。迁移涉及101个景点，覆盖13个国家和地区。

## 数据源分析

### 1. LocalAttractionsDB (本地景点数据库)
- **文件位置**: `/workspace/backend/local_attractions_db.py`
- **数据范围**: 北京市23个精选景点
- **数据特点**: 
  - 包含详细的中文描述
  - 部分使用Base64编码的SVG图片
  - 包含完整的地理位置信息

### 2. GlobalCitiesDB (全球城市数据库)
- **文件位置**: `/workspace/backend/global_cities_db.py`
- **数据范围**: 全球13个城市，78个景点
- **覆盖城市**:
  - **国际城市**: 巴黎(6)、伦敦(6)、罗马(5)、纽约(5)、东京(5)、巴塞罗那(4)、曼谷(4)、伊斯坦布尔(4)
  - **中国城市**: 北京(23)、西安(4)、杭州(3)、成都(3)、上海(6)

## 数据迁移映射

### 字段映射表

| 源字段 | 目标表 | 目标字段 | 数据转换 |
|--------|--------|----------|----------|
| `name` | `spot_attractions` | `name` | 直接映射 |
| `latitude` + `longitude` | `spot_attractions` | `location` | `ST_SetSRID(ST_MakePoint(longitude, latitude), 4326)` |
| `category` | `spot_attractions` | `category` | 直接映射 |
| `country` | `spot_attractions` | `country` | 直接映射 |
| `city` | `spot_attractions` | `city` | 直接映射 |
| `address` | `spot_attractions` | `address` | 直接映射 |
| `opening_hours` | `spot_attractions` | `opening_hours` | 直接映射 |
| `ticket_price` | `spot_attractions` | `ticket_price` | 直接映射 |
| `booking_method` | `spot_attractions` | `booking_method` | 直接映射 |
| `image` | `spot_attractions` | `main_image_url` | 直接映射 |
| `video` | `spot_attractions` | `video_url` | 直接映射 |
| `description` | `spot_attraction_contents` | `description` | 创建中文内容记录 (zh-CN) |
| `image` | `spot_attraction_media` | `url` | 创建图片媒体记录 |
| `video` | `spot_attraction_media` | `url` | 创建视频媒体记录 |

### 数据转换规则

1. **地理位置转换**:
   ```sql
   location = ST_SetSRID(ST_MakePoint(longitude, latitude), 4326)
   ```

2. **多语言内容处理**:
   - 所有中文描述插入到`spot_attraction_contents`表
   - `language_code`设置为`'zh-CN'`
   - `name_translated`与原始名称相同
   - `description`和`attraction_introduction`都使用原始描述

3. **媒体资源处理**:
   - 主图片：`media_type='image'`, `is_primary=true`, `order_index=0`
   - 视频：`media_type='video'`, `is_primary=false`, `order_index=1`

## 迁移脚本

### 1. SQL迁移脚本
**文件**: `/workspace/docs/spots/db/02历史数据迁移脚本0907.sql`

**特点**:
- 使用事务确保数据一致性
- 创建临时函数`migrate_attraction_data()`简化迁移过程
- 包含完整的数据验证查询
- 自动清理临时资源

**使用方法**:
```bash
# 通过Supabase Dashboard SQL编辑器执行
# 或使用psql命令行工具
psql -h db.uobwbhvwrciaxloqdizc.supabase.co -U postgres -d postgres -f 02历史数据迁移脚本0907.sql
```

### 2. Python迁移脚本
**文件**: `/workspace/migrate_historical_data.py`

**特点**:
- 面向对象设计，易于维护
- 详细的日志记录
- 错误处理和回滚机制
- 自动生成迁移报告
- 数据验证和统计

**使用方法**:
```bash
cd /workspace
python3 migrate_historical_data.py
```

## 迁移步骤

### 步骤1: 环境准备
1. 确保Supabase数据库已创建所有`spot_*`表
2. 安装必要的Python依赖：
   ```bash
   pip install psycopg2-binary
   ```

### 步骤2: 数据备份（可选）
```sql
-- 备份现有数据（如果有）
CREATE TABLE spot_attractions_backup AS SELECT * FROM spot_attractions;
CREATE TABLE spot_attraction_contents_backup AS SELECT * FROM spot_attraction_contents;
CREATE TABLE spot_attraction_media_backup AS SELECT * FROM spot_attraction_media;
```

### 步骤3: 执行迁移
选择以下方式之一：

**方式A: 使用SQL脚本（推荐）**
```bash
# 通过Supabase Dashboard执行SQL脚本
# 复制02历史数据迁移脚本0907.sql内容到SQL编辑器并执行
```

**方式B: 使用Python脚本**
```bash
cd /workspace
python3 migrate_historical_data.py
```

### 步骤4: 验证迁移结果
```sql
-- 验证基本统计
SELECT 
    '景点总数' as metric,
    COUNT(*) as count
FROM spot_attractions
UNION ALL
SELECT 
    '多语言内容总数' as metric,
    COUNT(*) as count  
FROM spot_attraction_contents
UNION ALL
SELECT 
    '媒体资源总数' as metric,
    COUNT(*) as count
FROM spot_attraction_media;

-- 按国家统计
SELECT 
    country as 国家,
    COUNT(*) as 景点数量
FROM spot_attractions
GROUP BY country
ORDER BY COUNT(*) DESC;

-- 验证地理位置数据
SELECT 
    name,
    ST_X(location) as 经度,
    ST_Y(location) as 纬度
FROM spot_attractions
WHERE location IS NOT NULL
LIMIT 10;
```

## 预期迁移结果

### 数据量统计
- **总景点数**: 101个
- **国家数**: 13个
- **城市数**: 13个
- **景点类别**: 15+个
- **多语言内容记录**: 101条 (zh-CN)
- **媒体资源记录**: 150+个

### 按国家分布
| 国家 | 景点数量 | 主要城市 |
|------|----------|----------|
| 中国 | 39 | 北京(23)、上海(6)、西安(4)、杭州(3)、成都(3) |
| 法国 | 6 | 巴黎 |
| 英国 | 6 | 伦敦 |
| 意大利 | 5 | 罗马 |
| 美国 | 5 | 纽约 |
| 日本 | 5 | 东京 |
| 西班牙 | 4 | 巴塞罗那 |
| 泰国 | 4 | 曼谷 |
| 土耳其 | 4 | 伊斯坦布尔 |

### 按类别分布
- **文化古迹**: 40+个
- **历史建筑**: 15+个
- **博物馆**: 8+个
- **现代建筑**: 6+个
- **自然景观**: 5+个
- **购物街区**: 5+个
- **其他类别**: 22+个

## 数据完整性验证

### 必检项目
1. **地理位置完整性**:
   ```sql
   SELECT COUNT(*) FROM spot_attractions WHERE location IS NULL;
   -- 应该返回0
   ```

2. **外键完整性**:
   ```sql
   SELECT COUNT(*) FROM spot_attraction_contents c
   LEFT JOIN spot_attractions a ON c.attraction_id = a.id
   WHERE a.id IS NULL;
   -- 应该返回0
   ```

3. **媒体资源完整性**:
   ```sql
   SELECT COUNT(*) FROM spot_attraction_media m
   LEFT JOIN spot_attractions a ON m.attraction_id = a.id
   WHERE a.id IS NULL;
   -- 应该返回0
   ```

### 数据质量检查
1. **空值检查**:
   ```sql
   SELECT 
     COUNT(*) FILTER (WHERE name IS NULL OR name = '') as empty_names,
     COUNT(*) FILTER (WHERE country IS NULL OR country = '') as empty_countries,
     COUNT(*) FILTER (WHERE city IS NULL OR city = '') as empty_cities
   FROM spot_attractions;
   ```

2. **重复数据检查**:
   ```sql
   SELECT name, country, city, COUNT(*)
   FROM spot_attractions
   GROUP BY name, country, city
   HAVING COUNT(*) > 1;
   ```

## 故障排除

### 常见问题

1. **连接超时**:
   - 检查网络连接
   - 确认数据库URL和凭据正确

2. **外键约束错误**:
   - 确保`users`表已存在
   - 检查表创建顺序

3. **地理位置数据错误**:
   - 确认PostGIS扩展已启用
   - 检查经纬度数据格式

4. **字符编码问题**:
   - 确保数据库使用UTF-8编码
   - 检查中文字符显示

### 回滚操作
如果迁移失败，可以使用以下命令回滚：

```sql
-- 清空迁移的数据
TRUNCATE spot_user_behaviors CASCADE;
TRUNCATE spot_attraction_embeddings CASCADE;
TRUNCATE spot_album_attractions CASCADE;
TRUNCATE spot_attraction_media CASCADE;
TRUNCATE spot_attraction_contents CASCADE;
TRUNCATE spot_attractions CASCADE;

-- 如果有备份，可以恢复
-- INSERT INTO spot_attractions SELECT * FROM spot_attractions_backup;
```

## 迁移后续工作

### 1. 索引优化
```sql
-- 重建统计信息
ANALYZE spot_attractions;
ANALYZE spot_attraction_contents;
ANALYZE spot_attraction_media;

-- 检查索引使用情况
SELECT schemaname, tablename, indexname, idx_tup_read, idx_tup_fetch
FROM pg_stat_user_indexes
WHERE schemaname = 'public' AND tablename LIKE 'spot_%';
```

### 2. 权限设置
```sql
-- 确保RLS策略正常工作
SELECT schemaname, tablename, rowsecurity
FROM pg_tables
WHERE schemaname = 'public' AND tablename LIKE 'spot_%';
```

### 3. 应用程序更新
1. 更新API端点以使用新的表名
2. 修改查询语句适配新的数据结构
3. 更新前端组件的数据绑定

## 性能优化建议

### 1. 查询优化
- 使用地理位置索引进行附近景点查询
- 为常用字段创建复合索引
- 使用视图简化复杂查询

### 2. 缓存策略
- 缓存热门景点数据
- 缓存国家和城市列表
- 实现分页查询

### 3. 监控指标
- 查询响应时间
- 索引命中率
- 数据库连接数

## 总结

本次数据迁移成功将101个景点从本地Python文件迁移到Supabase数据库，建立了完整的关系型数据结构，为Spot地图相册系统提供了坚实的数据基础。

### 迁移成果
✅ **数据完整性**: 所有101个景点数据完整迁移  
✅ **关系完整性**: 建立了景点、内容、媒体的关联关系  
✅ **多语言支持**: 为未来国际化奠定基础  
✅ **地理位置**: 支持基于位置的查询和分析  
✅ **媒体资源**: 统一管理图片和视频资源  

### 后续计划
1. 实施数据监控和备份策略
2. 开发数据管理界面
3. 集成AI向量搜索功能
4. 扩展多语言内容支持

---

**文档状态**: ✅ 完成  
**最后更新**: 2024-12-13  
**下次审查**: 2024-12-20