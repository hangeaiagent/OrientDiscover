# 🗄️ Spot地图相册系统 - Supabase数据库集成

## 📋 概述

本项目已成功集成Supabase数据库，将原有的本地文件数据源（`local_attractions_db.py` 和 `global_cities_db.py`）迁移到云端数据库。

## 🚀 快速开始

### 1. 环境配置

确保`.env`文件包含以下Supabase配置：

```bash
# Supabase配置
SUPABASE_URL=https://uobwbhvwrciaxloqdizc.supabase.co
SUPABASE_ANON_KEY=your_anon_key_here
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here
```

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

### 3. 启动后端服务

```bash
# 方法1: 使用启动脚本
python start_supabase_backend.py

# 方法2: 直接启动
cd backend
python -m uvicorn main:app --host 0.0.0.0 --port 8001 --reload
```

### 4. 测试集成

```bash
# 运行连接测试
python test_supabase_connection.py

# 或在浏览器中打开测试页面
http://localhost:3000/test_supabase_api.html
```

## 🔗 API端点

### 新增的Supabase API端点：

| 端点 | 方法 | 描述 |
|------|------|------|
| `/api/spot/health` | GET | 服务健康检查 |
| `/api/spot/attractions` | GET | 获取所有景点 |
| `/api/spot/attractions/nearby` | GET | 查询附近景点 |
| `/api/spot/attractions/category/{category}` | GET | 按类别查询景点 |
| `/api/spot/attractions/city/{city}` | GET | 按城市查询景点 |
| `/api/spot/attractions/search` | GET | 搜索景点 |
| `/api/spot/statistics` | GET | 获取统计信息 |
| `/api/explore-supabase` | POST | 使用Supabase数据探索 |

### 参数说明：

**附近景点查询** (`/api/spot/attractions/nearby`):
- `latitude`: 纬度 (必需)
- `longitude`: 经度 (必需)  
- `radius`: 搜索半径，单位公里 (默认50)

**搜索景点** (`/api/spot/attractions/search`):
- `query`: 搜索关键词 (必需，至少2个字符)

## 🗄️ 数据库结构

数据库包含以下主要表：

- `spot_attractions`: 景点主表
- `spot_attraction_contents`: 多语言内容表
- `spot_attraction_media`: 媒体资源表
- `spot_map_albums`: 地图相册表
- `spot_user_behaviors`: 用户行为表

详细结构请参考：`docs/spots/db/01数据库结构0907.md`

## 🔄 数据迁移

### 历史数据迁移状态：

- ✅ 数据库结构已创建
- ✅ 后端API已开发
- ✅ 前端代码已更新
- ⏳ 数据迁移脚本：`docs/spots/db/02历史数据迁移脚本0907.sql`

### 迁移步骤：

1. 在Supabase控制台执行 `docs/spots/db/database_setup.sql`
2. 执行数据迁移脚本 `docs/spots/db/02历史数据迁移脚本0907.sql`
3. 验证数据完整性

## 🧪 测试功能

### 1. 连接测试
```bash
python test_supabase_connection.py
```

### 2. Web界面测试
访问 `http://localhost:3000/test_supabase_api.html` 进行交互式测试

### 3. API文档
访问 `http://localhost:8001/docs` 查看完整API文档

## 📂 文件结构

```
backend/
├── supabase_client.py          # Supabase客户端配置
├── spot_api_service.py         # API服务层
├── main.py                     # 主应用（已添加Supabase端点）
└── ...

docs/spots/db/
├── 01数据库结构0907.md         # 数据库结构文档
├── 02历史数据迁移方案0907.md   # 数据迁移方案
├── 02历史数据迁移脚本0907.sql  # 数据迁移脚本
└── database_setup.sql          # 数据库创建脚本

test_supabase_api.html          # Web测试界面
test_supabase_connection.py     # 连接测试脚本
start_supabase_backend.py       # 启动脚本
.env.example                    # 环境变量示例
```

## 📝 日志配置

### 日志文件位置
- **后端日志**: `logs/backend.log`
- **前端日志**: `logs/frontend.log`
- **启动日志**: `logs/startup.log`

### 日志级别
- ERROR: 错误信息
- WARNING: 警告信息
- INFO: 一般信息
- DEBUG: 调试信息

### 查看日志命令
```bash
# 查看后端日志
tail -f logs/backend.log

# 查看前端日志
tail -f logs/frontend.log

# 查看启动日志
tail -f logs/startup.log
```

### 日志轮转
- 每天自动轮转
- 保留最近7天的日志
- 压缩历史日志

### 日志内容
1. **后端日志**:
   - API请求记录
   - 数据库操作
   - 错误追踪
   - 性能指标

2. **前端日志**:
   - 用户操作
   - API调用
   - 渲染性能
   - 错误报告

3. **启动日志**:
   - 环境检查
   - 依赖验证
   - 服务启动
   - 配置加载

## 🔧 前端集成

前端代码已更新，主要变更：

### app.js 变更：
```javascript
// 原来使用本地数据
const apiEndpoint = `${API_BASE_URL}/api/explore-real`;

// 现在使用Supabase数据库
const apiEndpoint = `${API_BASE_URL}/api/explore-supabase`;
```

### 数据流程：
1. 用户在前端发起探索请求
2. 前端调用 `/api/explore-supabase` 端点
3. 后端从Supabase数据库查询景点数据
4. 返回格式化的景点信息给前端
5. 前端显示景点卡片和详细信息

## 🚨 故障排除

### 常见问题：

1. **连接失败**
   - 检查`.env`文件中的Supabase配置
   - 确认Supabase URL和密钥正确
   - 检查网络连接

2. **数据为空**
   - 确认数据库中有数据
   - 检查数据迁移是否完成
   - 验证表名和字段名是否正确

3. **权限错误**
   - 检查RLS（行级安全）策略
   - 确认API密钥权限
   - 验证用户认证状态

### 调试命令：
```bash
# 检查服务状态
curl http://localhost:8001/api/spot/health

# 测试景点查询
curl "http://localhost:8001/api/spot/attractions/nearby?latitude=39.9042&longitude=116.4074&radius=50"

# 查看日志
tail -f backend.log
```

## 📈 性能优化

### 已实现的优化：
- ✅ 数据库索引优化
- ✅ 地理位置空间索引
- ✅ 查询结果缓存
- ✅ 连接池管理

### 计划中的优化：
- ⏳ Redis缓存集成
- ⏳ CDN图片加速
- ⏳ 数据库读写分离
- ⏳ 向量搜索优化

## 🔮 未来计划

1. **功能扩展**
   - 相册管理功能
   - 用户行为分析
   - AI推荐算法
   - 多语言内容扩充

2. **技术升级**
   - GraphQL API支持
   - 实时数据同步
   - 离线数据缓存
   - 移动端适配

## 📞 技术支持

如有问题，请：
1. 查看本文档的故障排除部分
2. 运行测试脚本诊断问题
3. 查看API文档了解详细用法
4. 检查数据库配置和连接状态

---

**最后更新**: 2024-12-13  
**版本**: v1.0.0  
**状态**: ✅ 生产就绪