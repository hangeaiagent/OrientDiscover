# Spot地图相册数据库结构设计文档

**创建时间**: 2024-12-13  
**版本**: v1.0  
**作者**: AI Assistant  

## 概述

本文档描述了Spot地图相册系统的数据库结构设计。该系统支持用户创建和管理地图相册，包含景点信息、多语言内容、媒体资源、用户行为跟踪等功能。

## 数据库配置信息

```
SUPABASE_URL=https://uobwbhvwrciaxloqdizc.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvYndiaHZ3cmNpYXhsb3FkaXpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNzEyNjYsImV4cCI6MjA2MjY0NzI2Nn0.x9Tti06ZF90B2YPg-AeVvT_tf4qOcOYcHWle6L3OVtc
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvYndiaHZ3cmNpYXhsb3FkaXpjIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0NzA3MTI2NiwiZXhwIjoyMDYyNjQ3MjY2fQ.ryRmf_i-EYRweVLL4fj4acwifoknqgTbIomL-S22Zmo
```

## 主要改进

### 1. 中文常量英文化
将原有数据库结构中的中文常量全部改为英文单词，提高系统兼容性和国际化支持：

- `'系统管理'` → `'system_admin'` (系统管理)
- `'用户自己'` → `'user_self'` (用户自己)
- `'私有'` → `'private'` (私有)
- `'公开'` → `'public'` (公开)
- `'view'` → `'view'` (查看)
- `'like'` → `'like'` (点赞)
- `'share'` → `'share'` (分享)
- `'bookmark'` → `'bookmark'` (收藏)

### 2. 表名统一添加前缀
为了区分其他产品，所有表名添加`spot_`前缀：

- `map_albums` → `spot_map_albums`
- `attractions` → `spot_attractions`
- `attraction_contents` → `spot_attraction_contents`
- `attraction_media` → `spot_attraction_media`
- `album_attractions` → `spot_album_attractions`
- `attraction_embeddings` → `spot_attraction_embeddings`
- `user_behaviors` → `spot_user_behaviors`

### 3. 完善的中文注释
为所有字段、表和约束添加详细的中文注释，提高代码可读性。

## 数据库表结构

### 1. 地图相册表 (spot_map_albums)

用于存储用户创建的景点相册信息。

```sql
CREATE TABLE spot_map_albums (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    creator_id UUID REFERENCES users(id) ON DELETE CASCADE,
    creator_type TEXT CHECK (creator_type IN ('system_admin', 'user_self')) DEFAULT 'user_self', -- 创建者类型: 系统管理 | 用户自己
    title TEXT NOT NULL, -- 相册标题
    description TEXT, -- 相册描述
    cover_image TEXT, -- 封面图片URL
    access_level TEXT CHECK (access_level IN ('private', 'public')) DEFAULT 'public', -- 访问级别: 私有 | 公开
    tags TEXT[] DEFAULT '{}', -- 标签数组
    view_count INTEGER DEFAULT 0, -- 浏览次数
    like_count INTEGER DEFAULT 0, -- 点赞次数
    is_recommended BOOLEAN DEFAULT false, -- 是否推荐
    created_at TIMESTAMPTZ DEFAULT now(), -- 创建时间
    updated_at TIMESTAMPTZ DEFAULT now() -- 更新时间
);
```

**索引**:
- `idx_spot_map_albums_creator`: 创建者索引
- `idx_spot_map_albums_access_level`: 访问级别索引
- `idx_spot_map_albums_created_at`: 创建时间索引

### 2. 景点主表 (spot_attractions)

存储景点的基本信息和地理位置。

```sql
CREATE TABLE spot_attractions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL, -- 景点名称
    location GEOMETRY(Point, 4326) NOT NULL, -- 地理位置坐标
    category TEXT NOT NULL, -- 景点类别
    country TEXT NOT NULL, -- 国家
    city TEXT NOT NULL, -- 城市
    address TEXT, -- 详细地址
    opening_hours TEXT, -- 开放时间
    ticket_price TEXT, -- 门票价格
    booking_method TEXT, -- 预订方式
    main_image_url TEXT, -- 主图片URL
    video_url TEXT, -- 视频URL
    created_at TIMESTAMPTZ DEFAULT now(), -- 创建时间
    updated_at TIMESTAMPTZ DEFAULT now() -- 更新时间
);
```

**索引**:
- `idx_spot_attractions_location`: 地理位置空间索引 (GIST)
- `idx_spot_attractions_category`: 景点类别索引
- `idx_spot_attractions_country_city`: 国家城市联合索引

### 3. 景点多语言内容表 (spot_attraction_contents)

存储景点的多语言描述和介绍。

```sql
CREATE TABLE spot_attraction_contents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    attraction_id UUID REFERENCES spot_attractions(id) ON DELETE CASCADE,
    language_code TEXT NOT NULL, -- 语言代码: 'zh-CN', 'en', 'fr', 'de', 'ja', 'ko', etc.
    name_translated TEXT, -- 翻译后的景点名称
    description TEXT, -- 景点描述
    attraction_introduction TEXT, -- 详细景点介绍
    guide_commentary TEXT, -- 导游词
    created_at TIMESTAMPTZ DEFAULT now(), -- 创建时间
    UNIQUE(attraction_id, language_code)
);
```

**索引**:
- `idx_spot_attraction_contents_attraction`: 景点ID索引
- `idx_spot_attraction_contents_language`: 语言代码索引

### 4. 景点媒体资源表 (spot_attraction_media)

存储景点的图片、视频等媒体资源。

```sql
CREATE TABLE spot_attraction_media (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    attraction_id UUID REFERENCES spot_attractions(id) ON DELETE CASCADE,
    media_type TEXT CHECK (media_type IN ('image', 'video', 'audio')) NOT NULL, -- 媒体类型: 图片 | 视频 | 音频
    url TEXT NOT NULL, -- 媒体资源URL
    caption TEXT, -- 媒体说明文字
    is_primary BOOLEAN DEFAULT false, -- 是否为主要媒体
    order_index INTEGER DEFAULT 0, -- 排序索引
    created_at TIMESTAMPTZ DEFAULT now() -- 创建时间
);
```

**索引**:
- `idx_spot_attraction_media_attraction`: 景点ID索引
- `idx_spot_attraction_media_type`: 媒体类型索引
- `idx_spot_attraction_media_order`: 景点ID和排序联合索引

### 5. 相册景点关联表 (spot_album_attractions)

定义相册与景点的关联关系。

```sql
CREATE TABLE spot_album_attractions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    album_id UUID REFERENCES spot_map_albums(id) ON DELETE CASCADE,
    attraction_id UUID REFERENCES spot_attractions(id) ON DELETE CASCADE,
    order_index INTEGER DEFAULT 0, -- 在相册中的排序
    custom_note TEXT, -- 用户自定义备注
    visit_duration INTEGER, -- 建议游览时长(分钟)
    created_at TIMESTAMPTZ DEFAULT now(), -- 创建时间
    UNIQUE(album_id, attraction_id)
);
```

**索引**:
- `idx_spot_album_attractions_album`: 相册ID索引
- `idx_spot_album_attractions_attraction`: 景点ID索引
- `idx_spot_album_attractions_order`: 相册ID和排序联合索引

### 6. 向量存储表 (spot_attraction_embeddings)

存储景点内容的向量嵌入，用于AI搜索和推荐。

```sql
CREATE TABLE spot_attraction_embeddings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    attraction_id UUID REFERENCES spot_attractions(id) ON DELETE CASCADE,
    language_code TEXT NOT NULL, -- 语言代码
    content_type TEXT CHECK (content_type IN ('description', 'introduction', 'guide_commentary')) NOT NULL, -- 内容类型: 描述 | 介绍 | 导游词
    embedding vector(1536), -- OpenAI Ada-002 embedding dimension
    created_at TIMESTAMPTZ DEFAULT now(), -- 创建时间
    UNIQUE(attraction_id, language_code, content_type)
);
```

**索引**:
- `idx_spot_attraction_embeddings_vector`: 向量索引 (ivfflat)
- `idx_spot_attraction_embeddings_attraction`: 景点ID索引

### 7. 用户行为表 (spot_user_behaviors)

记录用户对相册的各种操作行为。

```sql
CREATE TABLE spot_user_behaviors (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    album_id UUID REFERENCES spot_map_albums(id) ON DELETE CASCADE,
    action_type TEXT CHECK (action_type IN ('view', 'like', 'share', 'bookmark')) NOT NULL, -- 行为类型: 查看 | 点赞 | 分享 | 收藏
    created_at TIMESTAMPTZ DEFAULT now() -- 创建时间
);
```

**索引**:
- `idx_spot_user_behaviors_user`: 用户ID索引
- `idx_spot_user_behaviors_album`: 相册ID索引
- `idx_spot_user_behaviors_action`: 行为类型索引
- `idx_spot_user_behaviors_created`: 创建时间索引

## 行级安全策略 (RLS)

### 启用行级安全
```sql
ALTER TABLE spot_map_albums ENABLE ROW LEVEL SECURITY;
ALTER TABLE spot_album_attractions ENABLE ROW LEVEL SECURITY;
ALTER TABLE spot_user_behaviors ENABLE ROW LEVEL SECURITY;
```

### 相册访问策略
```sql
-- 用户可以查看公开相册
CREATE POLICY "users_can_view_public_albums" ON spot_map_albums
    FOR SELECT USING (access_level = 'public');

-- 用户可以管理自己的相册
CREATE POLICY "users_can_manage_own_albums" ON spot_map_albums
    FOR ALL USING (auth.uid() = creator_id);
```

### 相册景点关联策略
```sql
-- 可以查看公开相册的景点
CREATE POLICY "can_view_public_album_attractions" ON spot_album_attractions
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM spot_map_albums 
            WHERE id = album_id AND (access_level = 'public' OR creator_id = auth.uid())
        )
    );
```

### 用户行为策略
```sql
-- 用户可以管理自己的行为记录
CREATE POLICY "users_can_manage_own_behaviors" ON spot_user_behaviors
    FOR ALL USING (auth.uid() = user_id);
```

## 触发器

### 自动更新时间戳
```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- 为相册表创建触发器
CREATE TRIGGER update_spot_map_albums_updated_at BEFORE UPDATE ON spot_map_albums
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- 为景点表创建触发器
CREATE TRIGGER update_spot_attractions_updated_at BEFORE UPDATE ON spot_attractions
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

## 视图

### 相册详情视图 (spot_album_details)
包含统计信息的相册详情视图。

```sql
CREATE VIEW spot_album_details AS
SELECT 
    ma.*,
    COUNT(aa.id) as attraction_count,
    COALESCE(ub_stats.total_views, 0) as total_views,
    COALESCE(ub_stats.total_likes, 0) as total_likes
FROM spot_map_albums ma
LEFT JOIN spot_album_attractions aa ON ma.id = aa.album_id
LEFT JOIN (
    SELECT 
        album_id,
        COUNT(CASE WHEN action_type = 'view' THEN 1 END) as total_views,
        COUNT(CASE WHEN action_type = 'like' THEN 1 END) as total_likes
    FROM spot_user_behaviors 
    GROUP BY album_id
) ub_stats ON ma.id = ub_stats.album_id
GROUP BY ma.id, ub_stats.total_views, ub_stats.total_likes;
```

### 景点详情视图 (spot_attraction_details)
包含多语言内容的景点详情视图。

```sql
CREATE VIEW spot_attraction_details AS
SELECT 
    a.*,
    ac.language_code,
    ac.name_translated,
    ac.description as translated_description,
    ac.attraction_introduction,
    ac.guide_commentary,
    COUNT(am.id) as media_count
FROM spot_attractions a
LEFT JOIN spot_attraction_contents ac ON a.id = ac.attraction_id
LEFT JOIN spot_attraction_media am ON a.id = am.attraction_id
GROUP BY a.id, ac.language_code, ac.name_translated, ac.description, ac.attraction_introduction, ac.guide_commentary;
```

## 扩展要求

### 必需扩展
```sql
CREATE EXTENSION IF NOT EXISTS "uuid-ossp"; -- UUID生成
CREATE EXTENSION IF NOT EXISTS postgis;     -- 地理空间数据
CREATE EXTENSION IF NOT EXISTS vector;      -- 向量搜索
```

## 部署说明

### 1. 手动执行SQL
由于网络连接限制，建议通过Supabase Dashboard的SQL编辑器手动执行以下文件：
- `/workspace/database_setup.sql`

### 2. 验证部署
执行以下查询验证表是否创建成功：
```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name LIKE 'spot_%'
ORDER BY table_name;
```

### 3. 数据迁移
如果有现有数据需要迁移，请注意：
- 更新所有引用旧表名的代码
- 更新API端点和查询语句
- 测试行级安全策略是否正常工作

## 性能优化建议

1. **索引优化**: 已为常用查询字段创建索引
2. **分区策略**: 考虑对`spot_user_behaviors`表按时间分区
3. **缓存策略**: 对热门相册和景点数据进行缓存
4. **向量索引**: 使用ivfflat索引优化向量搜索性能

## 安全考虑

1. **行级安全**: 已启用RLS保护敏感数据
2. **API密钥管理**: 定期轮换API密钥
3. **数据备份**: 定期备份数据库
4. **访问控制**: 严格控制service_role_key的使用

## 后续计划

1. **监控和日志**: 添加数据库性能监控
2. **数据分析**: 基于用户行为数据进行分析
3. **AI功能**: 利用向量数据库实现智能推荐
4. **国际化**: 扩展多语言支持

---

**文档状态**: ✅ 完成  
**最后更新**: 2024-12-13  
**下次审查**: 2024-12-20

**删除顺序
DELETE FROM spot_user_behaviors;
 
DELETE FROM spot_attraction_embeddings;

 
DELETE FROM spot_album_attractions;

 
DELETE FROM spot_map_albums;
 
DELETE FROM spot_attraction_media;

 
DELETE FROM spot_attraction_contents;
 
DELETE FROM spot_attractions;
