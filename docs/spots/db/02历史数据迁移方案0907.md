# Spot地图相册系统 - 历史数据迁移方案

## 📋 概述

本文档描述了将现有的景点数据从本地JSON文件迁移到新的Supabase数据库系统的详细方案。

### 数据来源
- **本地北京景点**: `local_attractions_db.py` (23个景点)
- **全球城市景点**: `global_cities_db.py` (78个景点)
- **总计景点数量**: 101个景点

## 🗄️ 数据迁移范围

### 1. 景点基础信息
- 名称、位置坐标
- 类别、国家、城市
- 开放时间、票价
- 预订方式

### 2. 多语言内容
- 中文名称和描述
- 景点介绍
- 预留其他语言扩展

### 3. 媒体资源
- 主图片URL
- 视频URL
- 预留其他媒体类型

## 🛠️ 技术实现

### 迁移工具
- **主要脚本**: `02历史数据迁移脚本0907.sql`
- **执行方式**: 通过psql直接执行
- **事务保证**: 使用单一事务包装所有操作

### 数据转换规则
1. **位置信息**:
   ```sql
   ST_SetSRID(ST_MakePoint(longitude, latitude), 4326)
   ```

2. **多语言处理**:
   ```sql
   INSERT INTO spot_attraction_contents (
       language_code = 'zh-CN',
       name_translated = original_name,
       description = original_description
   )
   ```

3. **媒体资源**:
   ```sql
   INSERT INTO spot_attraction_media (
       media_type = 'image'/'video',
       is_primary = true/false
   )
   ```

## 📊 数据验证

### 验证SQL查询
```sql
-- 总量统计
SELECT COUNT(*) FROM spot_attractions;
SELECT COUNT(*) FROM spot_attraction_contents;
SELECT COUNT(*) FROM spot_attraction_media;

-- 分组统计
SELECT country, COUNT(*) FROM spot_attractions GROUP BY country;
SELECT category, COUNT(*) FROM spot_attractions GROUP BY category;

-- 地理位置验证
SELECT name, ST_X(location) as lon, ST_Y(location) as lat 
FROM spot_attractions;
```

### 预期结果
- 景点总数: 101
- 多语言内容: 101 (中文)
- 媒体资源: 约150-200 (每个景点1-2个)

## 🔄 回滚方案

如果迁移过程中出现问题，可以使用以下SQL进行回滚：

```sql
BEGIN;
DELETE FROM spot_user_behaviors;
DELETE FROM spot_attraction_embeddings;
DELETE FROM spot_album_attractions;
DELETE FROM spot_map_albums;
DELETE FROM spot_attraction_media;
DELETE FROM spot_attraction_contents;
DELETE FROM spot_attractions;
COMMIT;
```

## ✅ 完成标准

1. 所有景点数据成功导入
2. 验证查询返回预期结果
3. 随机抽查10个景点的完整性
4. 地理位置显示正确
5. 媒体资源可访问

## 📝 注意事项

1. 执行前备份现有数据
2. 检查URL的有效性
3. 验证经纬度准确性
4. 确保字符编码统一
5. 记录迁移日志

## 🎯 后续优化

1. 添加更多语言支持
2. 扩充媒体资源
3. 优化地理索引
4. 添加用户生成内容
5. 实现向量搜索
